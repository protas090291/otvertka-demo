# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á

## –ü—Ä–æ–±–ª–µ–º–∞
–û—à–∏–±–∫–∞ "–∑–∞–¥–∞—á–∞ –Ω–µ –±—ã–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞" –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `handleSaveEditTask` –≤ —Ñ–∞–π–ª–µ `ScheduleViewWithAPI.tsx`.

## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

–í –∫–æ–¥–µ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–±–ª–µ–º:

1. **–ü—Ä–æ–±–ª–µ–º–∞ —Å RLS –ø–æ–ª–∏—Ç–∏–∫–∞–º–∏** - –æ—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–∏—á–∏–Ω–∞
2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫** - —Ñ—É–Ω–∫—Ü–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null` –ø—Ä–∏ –æ—à–∏–±–∫–µ
3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º** - –Ω–µ –≤—Å–µ –æ—à–∏–±–∫–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

## –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS –ø–æ–ª–∏—Ç–∏–∫
–í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç `fix_tasks_rls.sql` –≤ Supabase Dashboard.

### 2. –£–ª—É—á—à–µ–Ω–∏–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –≤ –∫–æ–¥–µ

–ó–∞–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `handleSaveEditTask` –≤ —Ñ–∞–π–ª–µ `Helper2/src/components/ScheduleViewWithAPI.tsx`:

```typescript
const handleSaveEditTask = async () => {
  if (!editingTask) {
    console.error('‚ùå –ù–µ—Ç –∑–∞–¥–∞—á–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
    return;
  }

  if (saving) {
    console.log('‚è≥ –£–∂–µ –∏–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    return;
  }

  setSaving(true);
  console.log('üîÑ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∑–∞–¥–∞—á–∏:', editingTask);
  console.log('üìä –î–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã:', editForm);

  try {
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
    let newStatus = editForm.status;
    if (editForm.progress === 0) {
      newStatus = 'pending';
    } else if (editForm.progress >= 1 && editForm.progress <= 99) {
      newStatus = 'in-progress';
    } else if (editForm.progress === 100) {
      newStatus = 'completed';
    }

    const updateData: TaskUpdate = {
      status: newStatus,
      progress: editForm.progress
    };

    console.log('üìù –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', updateData);

    // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
    console.log('üîç ID –∑–∞–¥–∞—á–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', editingTask);
    console.log('üîç –¢–∏–ø ID:', typeof editingTask);

    const updatedTask = await updateTask(editingTask, updateData);
    console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', updatedTask);
    
    if (updatedTask) {
      setTasks(prevTasks => 
        prevTasks.map(task => 
          task.id === editingTask 
            ? { ...task, status: newStatus, progress: editForm.progress }
            : task
        )
      );

      setNotificationMessage('–ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞–¥–∞—á–∏ –æ–±–Ω–æ–≤–ª–µ–Ω!');
      setShowNotification(true);
      setTimeout(() => setShowNotification(false), 3000);
      handleCancelEditTask();
    } else {
      console.error('‚ùå –ó–∞–¥–∞—á–∞ –Ω–µ –±—ã–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ - updateTask –≤–µ—Ä–Ω—É–ª null');
      console.error('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫ Supabase');
      setNotificationMessage('–û—à–∏–±–∫–∞: –∑–∞–¥–∞—á–∞ –Ω–µ –±—ã–ª–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.');
      setShowNotification(true);
    }
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:', error);
    console.error('‚ùå –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
      message: error.message,
      stack: error.stack,
      name: error.name
    });
    setNotificationMessage(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ${error.message}`);
    setShowNotification(true);
  } finally {
    setSaving(false);
  }
};
```

### 3. –£–ª—É—á—à–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ updateTask

–ó–∞–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é `updateTask` –≤ —Ñ–∞–π–ª–µ `Helper2/src/lib/tasksApi.ts`:

```typescript
export const updateTask = async (id: string, updates: TaskUpdate): Promise<Task | null> => {
  try {
    console.log('üîÑ API: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ —Å ID:', id);
    console.log('üìù API: –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', updates);
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if (!id || typeof id !== 'string') {
      console.error('‚ùå API: –ù–µ–≤–µ—Ä–Ω—ã–π ID –∑–∞–¥–∞—á–∏:', id);
      return null;
    }

    if (!updates || Object.keys(updates).length === 0) {
      console.error('‚ùå API: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
      return null;
    }
    
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º, —á—Ç–æ –∑–∞–¥–∞—á–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    console.log('üîç API: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏...');
    const { data: existingTask, error: checkError } = await supabaseAdmin
      .from('tasks')
      .select('id, name, status, progress')
      .eq('id', id)
      .single();

    if (checkError) {
      console.error('‚ùå API: –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏:', checkError);
      console.error('‚ùå API: –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏:', {
        message: checkError.message,
        details: checkError.details,
        hint: checkError.hint,
        code: checkError.code
      });
      return null;
    }

    if (!existingTask) {
      console.error('‚ùå API: –ó–∞–¥–∞—á–∞ —Å ID', id, '–Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
      return null;
    }

    console.log('‚úÖ API: –ó–∞–¥–∞—á–∞ –Ω–∞–π–¥–µ–Ω–∞:', existingTask);
    
    const updateData: any = {};
    
    if (updates.projectId !== undefined) updateData.project_id = updates.projectId;
    if (updates.name !== undefined) updateData.name = updates.name;
    if (updates.description !== undefined) updateData.description = updates.description;
    if (updates.status !== undefined) updateData.status = updates.status;
    if (updates.assignee !== undefined) updateData.assignee = updates.assignee;
    if (updates.startDate !== undefined) updateData.start_date = updates.startDate;
    if (updates.endDate !== undefined) updateData.end_date = updates.endDate;
    if (updates.progress !== undefined) updateData.progress = updates.progress;
    if (updates.dependencies !== undefined) updateData.dependencies = updates.dependencies;
    if (updates.order !== undefined) updateData.order_index = updates.order;

    console.log('üìä API: –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è Supabase:', updateData);

    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    console.log('üîÑ API: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ Supabase...');
    const { data, error } = await supabaseAdmin
      .from('tasks')
      .update(updateData)
      .eq('id', id)
      .select()
      .single();

    if (error) {
      console.error('‚ùå API: –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏:', error);
      console.error('‚ùå API: –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      return null;
    }

    if (!data) {
      console.error('‚ùå API: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –≤ –æ—Ç–≤–µ—Ç–µ –æ—Ç Supabase');
      return null;
    }

    console.log('‚úÖ API: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã –∏–∑ Supabase:', data);
    const mappedTask = mapToTask(data);
    console.log('‚úÖ API: –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–Ω–∞—è –∑–∞–¥–∞—á–∞:', mappedTask);
    
    return mappedTask;
  } catch (error) {
    console.error('‚ùå API: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ updateTask:', error);
    console.error('‚ùå API: –°—Ç–µ–∫ –æ—à–∏–±–∫–∏:', error.stack);
    return null;
  }
};
```

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –í—ã–ø–æ–ª–Ω–∏—Ç–µ SQL —Å–∫—Ä–∏–ø—Ç `fix_tasks_rls.sql`
2. –û—Ç–∫—Ä–æ–π—Ç–µ `debug_task_update.html` –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
- RLS –ø–æ–ª–∏—Ç–∏–∫–∏ –±—É–¥—É—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
- –û—à–∏–±–∫–∏ –±—É–¥—É—Ç –¥–µ—Ç–∞–ª—å–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å—Å—è
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∏—Ç –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö
