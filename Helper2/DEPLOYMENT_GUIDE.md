# Руководство по развертыванию голосового помощника

## Обзор системы

Система состоит из трех основных компонентов:
1. **Мобильное приложение** (React Native) - принимает голосовые команды
2. **Backend API** (FastAPI) - обрабатывает команды и предоставляет API
3. **Офисный агент** (Python) - генерирует документы и отправляет на печать

## Предварительные требования

### Для всех компонентов:
- Python 3.10+
- Node.js 18+
- Supabase аккаунт и проект

### Для мобильного приложения:
- Expo CLI
- React Native development environment

### Для офисного агента:
- Принтер, подключенный к компьютеру
- Python библиотеки для работы с документами

## 1. Настройка Supabase

### 1.1 Создание проекта
1. Зайдите в [Supabase Dashboard](https://supabase.com/dashboard)
2. Создайте новый проект
3. Запомните URL проекта и ключи API

### 1.2 Настройка базы данных
1. Откройте SQL Editor в Supabase Dashboard
2. Выполните скрипт из файла `supabase-voice-assistant-setup.sql`
3. Проверьте, что все таблицы созданы:
   - `commands`
   - `documents`
   - `agent_logs`

### 1.3 Настройка Storage
1. В Supabase Dashboard перейдите в Storage
2. Убедитесь, что bucket `documents` создан
3. Настройте политики доступа

## 2. Развертывание Backend API

### 2.1 Установка зависимостей
```bash
cd backend
pip install -r requirements.txt
```

### 2.2 Настройка переменных окружения
```bash
# Создайте файл .env в папке backend
cp ../env.example backend/.env

# Отредактируйте .env файл:
SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
```

### 2.3 Запуск сервера
```bash
cd backend
python main.py
```

Сервер будет доступен по адресу: http://localhost:8000

### 2.4 Проверка работы API
```bash
# Проверка здоровья API
curl http://localhost:8000/health

# Создание тестовой команды
curl -X POST http://localhost:8000/api/commands \
  -H "Content-Type: application/json" \
  -d '{
    "type": "create_act",
    "payload": {
      "apartment_id": "1101",
      "act_type": "handover",
      "meta": {"notes": "Тестовая команда"}
    }
  }'
```

## 3. Развертывание офисного агента

### 3.1 Установка зависимостей
```bash
cd office-agent
pip install -r requirements.txt
```

### 3.2 Настройка переменных окружения
```bash
# Создайте файл .env в папке office-agent
cp ../env.example office-agent/.env

# Отредактируйте .env файл:
SUPABASE_URL=your_supabase_url
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
PRINTER_NAME=your_printer_name  # Или оставьте пустым для принтера по умолчанию
```

### 3.3 Настройка принтера

#### Windows:
1. Убедитесь, что принтер установлен и работает
2. Запомните имя принтера в системе
3. Установите `pywin32`: `pip install pywin32`

#### Linux/macOS:
1. Убедитесь, что CUPS установлен и настроен
2. Проверьте доступные принтеры: `lpstat -p`

### 3.4 Запуск агента
```bash
cd office-agent
python agent.py
```

Агент начнет опрашивать команды каждые 5 секунд.

## 4. Развертывание мобильного приложения

### 4.1 Установка Expo CLI
```bash
npm install -g @expo/cli
```

### 4.2 Установка зависимостей
```bash
cd mobile-app
npm install
```

### 4.3 Настройка конфигурации
Отредактируйте файл `App.tsx`:
```typescript
const API_BASE_URL = 'http://YOUR_BACKEND_URL:8000';
const SUPABASE_URL = 'YOUR_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
```

### 4.4 Запуск приложения
```bash
cd mobile-app
expo start
```

### 4.5 Тестирование на устройстве
1. Установите Expo Go на ваш телефон
2. Отсканируйте QR код из терминала
3. Приложение откроется на телефоне

## 5. Тестирование системы

### 5.1 Тест полного цикла
1. Откройте мобильное приложение
2. Нажмите кнопку записи
3. Скажите: "Создай акт приёмки для квартиры 1101"
4. Проверьте, что команда появилась в backend
5. Убедитесь, что агент обработал команду
6. Проверьте, что документ создан и загружен в Storage

### 5.2 Тест печати
1. Скажите: "Распечатай акт для квартиры 1101"
2. Убедитесь, что документ напечатан на принтере

### 5.3 Проверка логов
```bash
# Логи агента
tail -f office-agent/agent.log

# Логи backend (в терминале где запущен сервер)
```

## 6. Мониторинг и отладка

### 6.1 Проверка статуса команд
```sql
-- В Supabase SQL Editor
SELECT * FROM commands ORDER BY created_at DESC LIMIT 10;
```

### 6.2 Проверка логов агента
```sql
-- В Supabase SQL Editor
SELECT * FROM agent_logs ORDER BY created_at DESC LIMIT 20;
```

### 6.3 Проверка документов
```sql
-- В Supabase SQL Editor
SELECT * FROM documents ORDER BY created_at DESC LIMIT 10;
```

## 7. Безопасность

### 7.1 Ключи API
- **Service Role Key** должен использоваться только на сервере и агенте
- **Anon Key** можно использовать в мобильном приложении
- Никогда не коммитьте ключи в репозиторий

### 7.2 Сетевая безопасность
- В продакшене используйте HTTPS
- Настройте CORS правильно
- Используйте VPN или приватные сети для связи между компонентами

## 8. Масштабирование

### 8.1 Backend
- Используйте Gunicorn для продакшена
- Настройте reverse proxy (nginx)
- Используйте базу данных с connection pooling

### 8.2 Агент
- Можно запустить несколько агентов на разных машинах
- Используйте Redis для координации между агентами
- Настройте мониторинг и автоматический перезапуск

### 8.3 Мобильное приложение
- Используйте Expo EAS Build для создания production билдов
- Настройте push уведомления для статуса команд
- Добавьте offline режим с синхронизацией

## 9. Troubleshooting

### 9.1 Агент не обрабатывает команды
- Проверьте подключение к Supabase
- Убедитесь, что Service Role Key правильный
- Проверьте логи агента

### 9.2 Мобильное приложение не отправляет команды
- Проверьте URL backend в конфигурации
- Убедитесь, что backend запущен
- Проверьте CORS настройки

### 9.3 Документы не печатаются
- Проверьте имя принтера
- Убедитесь, что принтер подключен и работает
- Проверьте права доступа к принтеру

### 9.4 Ошибки в логах
```bash
# Просмотр логов агента
tail -f office-agent/agent.log

# Просмотр логов backend
# Логи выводятся в консоль где запущен сервер
```

## 10. Дополнительные возможности

### 10.1 WebSocket для real-time обновлений
- Backend уже поддерживает WebSocket
- Можно добавить real-time уведомления в мобильное приложение

### 10.2 Расширенное распознавание речи
- Интеграция с Google Speech-to-Text
- Интеграция с Azure Speech Services
- Офлайн распознавание с Vosk

### 10.3 Дополнительные типы документов
- Акт скрытых работ
- Протокол испытаний
- Справки и сертификаты

### 10.4 Интеграция с существующим приложением
- API для получения данных о квартирах
- Интеграция с системой пользователей
- Синхронизация с основной базой данных


